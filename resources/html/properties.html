<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<script type="text/javascript" src="../js/jquery/jquery-1.6.1.min.js"></script>
<script type="text/javascript" src="../js/jquery-ext/jquery-ext.js"></script>
<script type="text/javascript" src="../js/json/json2.js"></script>

<script type="text/javascript"
	src="../js/jquery-ui/js/jquery-ui-1.8.13.custom.min.js"></script>
<link rel="stylesheet" type="text/css"
	href="../js/jquery-ui/css/smoothness/jquery-ui-1.8.13.custom.css" />

<title>Properties</title>

<style type="text/css">
#properties {
	margin: 0;
	padding: 0;
	width: 100%;
	border-collapse: collapse;
}

#properties td {
	padding: 3px;
	padding-left: 24px;
}

#properties td:first-child {
	width: 25%;
}

#properties td span.ui-icon {
	position: absolute;
	margin-left: -20px;
}
</style>

<script type="text/javascript">
		$(function() {
			var properties = $("#properties");

			var item = properties.find("tr").bindData('value', [1, 2, 4, 8, 16, 32], function(d) { return d; });
			
			item.enter("<tr>").addClass("ui-state-default")
			.html(function(index, oldhtml) { 
				var v = $(this).inherit('value');
				return '<td style="padding-left: 44px"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span><span>' + (v != 16 ? v : '&nbsp;') + '</span></td>'; 
			}).appendTo(properties);
		});
		
		// called by Java if content is stale
		function refresh() {
			updateItems();
		}
		
		function getDescendants(parent) {
			var dataLevel = parseInt(parent.attr("data-level"));
			var items = $();
			var next = parent.next();
			while (parseInt(next.attr("data-level")) > dataLevel) {
				items = items.add(next);
				next = next.next();
			}
			return items;
		}
		
		function createToggle(toggleResource) {
			var toggle = $("<span>").addClass("toggle ui-icon ui-icon-circle-plus").css("margin-left", "-40px");
			toggle.click(function() {
				var item = toggle.closest('tr');
				
				var s, p;
				if (toggleResource) {
					s = item.inherit('value').nominalValue;
				} else {
					s = item.attr("about");
					p = item.find("[rel]").attr("rel") || item.data('predicate');
				}
				
				if (toggle.hasClass("ui-icon-circle-plus")) {
					var firstCol;
					if (toggleResource) {
						var template = item.clone().attr("about", s);
						template.find("td").empty();
						firstCol = template.find("td:first-child");
						template.insertAfter(item);
						template.addClass("remove");
						template.attr("data-level", parseInt(item.attr('data-level') + 1));
					} else {
						// <create root node>
						var root = item.clone();
						root.data('predicate', p);
						root.find("td + td").empty();
						root.find(".toggle").replaceWith(toggle);
						item.find("td:first-child .label").html("&nbsp;");
						firstCol = item.find("td:first-child");
						// force deletion of template node
						item.data('value', {});
						root.insertBefore(item);
						item.attr("data-level", parseInt(item.attr('data-level') + 1));
						// </create root node>
					}
					firstCol.css("padding-left", parseInt(firstCol.css("padding-left")) + 20);
					
					updateItems(s, p);
				} else {
					var items = getDescendants(item);
					if (! toggleResource) {
						// <remove root node>
						var first = items.first();
						first.find('td:first-child').replaceWith(toggle.closest('td'));
						first.attr("data-level", parseInt(first.attr('data-level') - 1));
						item.remove();
						items = items.not(first);
						// </remove root node>
					}
					
					items.remove();
				}
				toggle.toggleClass("ui-icon-circle-plus ui-icon-circle-minus");
			});
			return toggle;
		}
		
		function createIcon(iconUrl) {
			if (iconUrl) {
				return $("<span>").toggleClass("ui-icon", true).css("background-image", "url('" + iconUrl + "')");
			}
			return $();
		}
		
		function createLabel(text) {
			var label = $("<span>").addClass("label");
			if (text) {
				label.text(text);
			} else {
				label.html('&nbsp;');
			}
			return label;
		}
		
		function selectItems(subject, predicate) {
			var selector = "tr";
			if (subject) {
				// filter rows by subject
				selector += '[about="' + subject + '"]';
				if (predicate) {
					// filter rows by predicate
					selector += ' [rel="' + predicate + '"]';
				}
			}
			
			var result = $("#properties").find(selector);
			if (subject && predicate) {
				result = result.closest("tr");
			}
			return result;
		}
		
		function updateItems(subject, predicate) {
			var response;
			if (subject != undefined) {
				if (predicate != undefined) {
					response = loadData(subject, predicate);
				} else {
					response = loadData(subject);
				}			    
			} else {
				response = loadData();
			}
			// $("#debug").text(response);
			
			var result = eval('(' + response + ')');
			if (result) {
				var presentation = result.presentation;
				
				var table = $('#properties');
				if (!subject) {
					table.empty();		
				}
			
				$.each(result.data, function(index, data) {
					var rows = selectItems(data.subject, data.predicate);
					
					var rows = rows
						.bindData('value', data.objects, function(d) { 
							return d.nominalValue ; 
						});
					
					var row = rows.enter("<tr>")
						.addClass("ui-state-default")
						// some RDFa
						.attr("about", data.subject);
					
					// column 1
					row.each(
						function() {
							var item = $(this);
							var rdfNode = item.inherit('value');
							var isResource = rdfNode.interfaceName != "Literal";
							
							// column 1
							var col = $("<td>")
							// add more padding for toggle icons
							.css("padding-left", "44px");
							
							if (data.hasMoreValues || isResource) {
								createToggle(data.hasMoreValues === undefined).appendTo(col);
							}

							createIcon(presentation[data.predicate].image).appendTo(col);
							createLabel(predicate ? null : presentation[data.predicate].label).appendTo(col);
							
							col.appendTo(item);
							
							// column 2
							col = $("<td>");						

							createIcon(presentation[rdfNode.nominalValue].image).appendTo(col);
	
							var label = createLabel(presentation[rdfNode.nominalValue].label).appendTo(col);
							
							// add some RDFa
							label.attr("rel", data.predicate);
							if (isResource) {
								label.attr("resource", rdfNode.nominalValue);
							}
							
							col.appendTo(item);
						}
					);
					
					// insert item at correct insertion point
					// TODO correctly determine lastItems
					var lastItems;
					if (subject && predicate || !subject && !predicate) {
						lastItems = selectItems(data.subject, data.predicate).last();
					} else {
						lastItems = selectItems(data.subject).last();
					}
					if (lastItems.length > 0) {
						// this supports multiple insertion points at different levels
						var nr = 0;
						lastItems.each(function() {
							if (nr > 0) {
								row = row.clone(true);
							}
							// set correct padding for level
							row.find("td:first-child")
								.css("padding-left", $(this).find("td:first-child").css("padding-left"));
							row.attr("data-level", $(this).attr("data-level"));
							
							row.insertAfter(this);
							
							if ($(this).hasClass('remove')) {
								$(this).remove();
							}
						});
					} else {
						row.attr("data-level", 0);
						row.appendTo(table);
					}
					
					rows.exit().remove();
					
					rows.exit().each(function() {
						var self = $(this);
						getDescendants(self).remove();
						self.remove();
					});
				});
			}
		}
	</script>
</head>

<body>
	<table id="properties" />
	<div id="debug" />
</body>
</html>